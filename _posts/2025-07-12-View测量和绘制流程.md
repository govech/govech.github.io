---
title: View æµ‹é‡å’Œç»˜åˆ¶æµç¨‹
date: 2025-07-12 14:00:00 +0800
categories: [Android]
tags: [Blog]
---



## ä¸€ã€æ•´ä½“ View æ¸²æŸ“æµç¨‹ï¼ˆä¸‰æ­¥ï¼‰

```
ViewRootImpl.performTraversals()
 â”œâ”€â”€ measure()
 â”œâ”€â”€ layout()
 â””â”€â”€ draw()
```

æˆ‘ä»¬èšç„¦ç¬¬ 1 æ­¥ï¼š

------

## äºŒã€ä» `ViewRootImpl.performTraversals()` å¼€å§‹

```java
private void performTraversals() {
    ...
    performMeasure();
    ...
}
```

### æºç ç‰‡æ®µï¼š`performMeasure()`

```java
private void performMeasure() {
    ...
    view.measure(childWidthMeasureSpec, childHeightMeasureSpec);
    ...
}
```

- `view` æ˜¯ä½ çš„æ ¹ Viewï¼ˆé€šå¸¸æ˜¯ `DecorView`ï¼‰
- `childWidthMeasureSpec` æ˜¯ç³»ç»Ÿæ ¹æ®çª—å£å¤§å°å’Œ `LayoutParams` æ¨ç®—å‡ºæ¥çš„ `MeasureSpec`

------

## ä¸‰ã€View.measure() çš„å†…éƒ¨é€»è¾‘

```java
public final void measure(int widthMeasureSpec, int heightMeasureSpec) {
    if ((mPrivateFlags & PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||
        needsLayout()) {
        // ğŸš© çœŸæ­£å¼€å§‹æµ‹é‡
        onMeasure(widthMeasureSpec, heightMeasureSpec);
        mPrivateFlags &= ~PFLAG_FORCE_LAYOUT;
    }
}
```

>  æ ¸å¿ƒç‚¹ï¼š`onMeasure()` æ˜¯æµ‹é‡å…³é”®ã€‚View/ViewGroup éƒ½ä¼šå®ç°å®ƒã€‚

------

## å››ã€æ·±å…¥ `View.onMeasure()`ï¼ˆé»˜è®¤å®ç°ï¼‰

```java
protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),
                         getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));
}
```

### `getDefaultSize(...)` çš„æºç ï¼š

```java
public static int getDefaultSize(int size, int measureSpec) {
    int mode = MeasureSpec.getMode(measureSpec);
    int specSize = MeasureSpec.getSize(measureSpec);

    switch (mode) {
        case MeasureSpec.UNSPECIFIED:
            return size;
        case MeasureSpec.AT_MOST:
        case MeasureSpec.EXACTLY:
        default:
            return specSize;
    }
}
```

 æ‰€ä»¥é»˜è®¤ `View` ä¼š **ç›´æ¥æ¥å— MeasureSpec ç»™çš„å€¼**ï¼Œä¸åšè‡ªé€‚åº”å¤„ç†ã€‚

> å¦‚æœä½ ä¸é‡å†™ `onMeasure()`ï¼Œä½ çš„ `wrap_content` æ˜¯æ— æ•ˆçš„ï¼

------

## äº”ã€MeasureSpec åŸç†æ·±å…¥

```java
public static class MeasureSpec {
    // ä½ 30 ä½æ˜¯ sizeï¼Œé«˜ 2 ä½æ˜¯ mode
    static final int MODE_SHIFT = 30;
    static final int MODE_MASK  = 0x3 << MODE_SHIFT;

    public static int makeMeasureSpec(int size, int mode) {
        return (size & ~MODE_MASK) | (mode << MODE_SHIFT);
    }

    public static int getMode(int measureSpec) {
        return (measureSpec & MODE_MASK) >> MODE_SHIFT;
    }

    public static int getSize(int measureSpec) {
        return (measureSpec & ~MODE_MASK);
    }
}
```

- `MeasureSpec` æ˜¯ä¸€ä¸ª 32 ä½ intï¼š
  - é«˜ä¸¤ä½è¡¨ç¤º Mode
  - ä½ 30 ä½è¡¨ç¤º Size

------

## å…­ã€ViewGroup çš„ onMeasureï¼šæµ‹é‡å­ View

ä»¥ `LinearLayout` ä¸ºä¾‹ï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæµ‹é‡æ¯ä¸ªå­ View çš„ï¼š

###  é‡ç‚¹æºç ï¼š`LinearLayout.onMeasure()`

```java
for (int i = 0; i < count; ++i) {
    View child = getChildAt(i);
    if (child.getVisibility() != GONE) {
        measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);

        // è®°å½•æœ€å¤§å®½é«˜ã€å¤„ç† weightã€wrap_content ç­‰é€»è¾‘
    }
}
```

###  æ ¸å¿ƒæ–¹æ³•ï¼š`measureChildWithMargins(...)`

```java
protected void measureChildWithMargins(
    View child, int parentWidthMeasureSpec, int widthUsed,
    int parentHeightMeasureSpec, int heightUsed
) {
    final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();

    final int childWidthMeasureSpec = getChildMeasureSpec(
        parentWidthMeasureSpec,
        mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed,
        lp.width
    );

    final int childHeightMeasureSpec = getChildMeasureSpec(
        parentHeightMeasureSpec,
        mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed,
        lp.height
    );

    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);
}
```

###  åˆè·³åˆ°äº†ï¼š`ViewGroup.getChildMeasureSpec()`

```java
public static int getChildMeasureSpec(int spec, int padding, int childDimension) {
    int specMode = MeasureSpec.getMode(spec);
    int specSize = MeasureSpec.getSize(spec);
    int size = Math.max(0, specSize - padding);

    if (childDimension >= 0) {
        return MeasureSpec.makeMeasureSpec(childDimension, MeasureSpec.EXACTLY);
    } else if (childDimension == LayoutParams.MATCH_PARENT) {
        return MeasureSpec.makeMeasureSpec(size, specMode);
    } else if (childDimension == LayoutParams.WRAP_CONTENT) {
        if (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) {
            return MeasureSpec.makeMeasureSpec(size, MeasureSpec.AT_MOST);
        } else {
            return MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED);
        }
    }
}
```

>  è¿™ä¸ªæ–¹æ³•æ˜¯å…³é”®ï¼š**çˆ¶æ§ä»¶æ ¹æ®è‡ªå·±çš„ MeasureSpec + padding + å­æ§ä»¶ LayoutParamsï¼Œæ„é€ å­æ§ä»¶çš„ MeasureSpec**

------

## ä¸ƒã€æœ€ç»ˆæµ‹é‡å®Œæˆ

æ‰€æœ‰ `View`ã€`ViewGroup` åœ¨ `onMeasure()` å†…é€šè¿‡å­ View çš„æµ‹é‡å’Œå°ºå¯¸ç¡®å®šè‡ªå·±çš„å®½é«˜ï¼Œå¹¶è°ƒç”¨ï¼š

```java
setMeasuredDimension(measuredWidth, measuredHeight)
```

è‡³æ­¤ï¼Œæµ‹é‡æµç¨‹ç»“æŸï¼Œè¿›å…¥ layout é˜¶æ®µã€‚

------

## å…«ã€æµç¨‹å›¾æ€»ç»“ï¼ˆè¶…æ¸…æ™°ï¼ï¼‰

```
ViewRootImpl.performTraversals()
 â””â”€â”€ performMeasure()
     â””â”€â”€ rootView.measure()
         â””â”€â”€ onMeasure()
             â”œâ”€â”€ View: è®¡ç®—è‡ªå·±éœ€è¦çš„å¤§å°
             â””â”€â”€ ViewGroup:
                 â”œâ”€â”€ éå†å­ View
                 â”œâ”€â”€ getChildMeasureSpec()
                 â””â”€â”€ child.measure()
                        â””â”€â”€ child.onMeasure()
```

------

## ä¹ã€å¯¹`public static int getChildMeasureSpec(int spec, int padding, int childDimension)`æ–¹æ³•çš„ç†è§£

### æ–¹æ³•æ¦‚è¿°

getChildMeasureSpec çš„ä½œç”¨æ˜¯ç”Ÿæˆå­è§†å›¾çš„ MeasureSpecï¼Œè¿™æ˜¯ä¸€ä¸ª 32 ä½æ•´æ•°ï¼ŒåŒ…å«æµ‹é‡æ¨¡å¼ï¼ˆEXACTLYã€AT_MOST æˆ– UNSPECIFIEDï¼‰å’Œå°ºå¯¸ã€‚å®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
public static int getChildMeasureSpec(int spec, int padding, int childDimension)
```

- **è¿”å›å€¼**ï¼šä¸€ä¸ªè¡¨ç¤ºå­è§†å›¾ MeasureSpec çš„æ•´æ•°ï¼ŒåŒ…å«æµ‹é‡æ¨¡å¼å’Œå°ºå¯¸ã€‚
- **ç›®çš„**ï¼šåè°ƒçˆ¶è§†å›¾çš„çº¦æŸå’Œå­è§†å›¾çš„å¸ƒå±€éœ€æ±‚ï¼Œç¡®ä¿å­è§†å›¾çš„æµ‹é‡ç¬¦åˆçˆ¶è§†å›¾çš„é™åˆ¶ã€‚

### å‚æ•°è§£æï¼š

æˆ‘ä»¬é€ä¸€åˆ†æä½ æä¾›çš„è°ƒç”¨ä¸­çš„å‚æ•°ï¼š

1. widthMeasureSpecï¼š
   - **ç±»å‹**ï¼šint
   - æè¿°ï¼šè¿™æ˜¯çˆ¶è§†å›¾çš„å®½åº¦ MeasureSpecï¼Œé€šå¸¸ä»çˆ¶è§†å›¾çš„ onMeasureæ–¹æ³•ä¼ é€’è¿‡æ¥ã€‚MeasureSpecåŒ…å«ï¼š
     - **æ¨¡å¼**ï¼ˆ2 ä½ï¼‰ï¼šEXACTLYï¼ˆå›ºå®šå°ºå¯¸ï¼‰ã€AT_MOSTï¼ˆæœ€å¤§å°ºå¯¸ï¼‰æˆ– UNSPECIFIEDï¼ˆæ— çº¦æŸï¼‰ã€‚
     - **å°ºå¯¸**ï¼ˆ30 ä½ï¼‰ï¼šå…·ä½“çš„åƒç´ å€¼ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ã€‚
   - ä½œç”¨ï¼šå®šä¹‰çˆ¶è§†å›¾å¯¹å­è§†å›¾å®½åº¦çš„çº¦æŸã€‚ä¾‹å¦‚ï¼š
     - EXACTLYï¼šçˆ¶è§†å›¾æœ‰å›ºå®šå®½åº¦ï¼Œå­è§†å›¾å¿…é¡»éµå®ˆã€‚
     - AT_MOSTï¼šçˆ¶è§†å›¾æœ‰æœ€å¤§å®½åº¦ï¼Œå­è§†å›¾ä¸èƒ½è¶…è¿‡ã€‚
     - UNSPECIFIEDï¼šçˆ¶è§†å›¾æ— çº¦æŸï¼Œå­è§†å›¾å¯è‡ªç”±å†³å®šå®½åº¦ã€‚
2. paddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼š
   - **ç±»å‹**ï¼šint
   - æè¿°ï¼šè¡¨ç¤ºæ²¿å®½åº¦è½´å·²ä½¿ç”¨çš„ç©ºé—´æ€»å’Œï¼Œå‡å°‘å­è§†å›¾çš„å¯ç”¨ç©ºé—´ï¼ŒåŒ…æ‹¬ï¼š
     - paddingLeftï¼šçˆ¶è§†å›¾çš„å·¦å†…è¾¹è·ã€‚
     - paddingRightï¼šçˆ¶è§†å›¾çš„å³å†…è¾¹è·ã€‚
     - lp.leftMarginï¼šå­è§†å›¾çš„å·¦å¤–è¾¹è·ï¼Œæ¥è‡ªå…¶ LayoutParamsï¼ˆå¦‚ MarginLayoutParamsï¼‰ã€‚
     - lp.rightMarginï¼šå­è§†å›¾çš„å³å¤–è¾¹è·ã€‚
   - **ä½œç”¨**ï¼šä»çˆ¶è§†å›¾çš„å¯ç”¨å®½åº¦ä¸­å‡å»è¿™äº›ç©ºé—´ï¼Œç¡®ä¿å­è§†å›¾çš„æµ‹é‡è€ƒè™‘äº†è¿™äº›éå†…å®¹åŒºåŸŸã€‚
3. lp.widthï¼š
   - **ç±»å‹**ï¼šint
   - æè¿°ï¼šå­è§†å›¾çš„ LayoutParams ä¸­æŒ‡å®šçš„å®½åº¦ï¼Œå¯ä»¥æ˜¯ï¼š
     - å…·ä½“åƒç´ å€¼ï¼ˆå¦‚ 100 è¡¨ç¤º 100 åƒç´ ï¼‰ã€‚
     - ViewGroup.LayoutParams.MATCH_PARENTï¼šå­è§†å›¾å¸Œæœ›ä¸çˆ¶è§†å›¾çš„å¯ç”¨å®½åº¦ä¸€è‡´ã€‚
     - ViewGroup.LayoutParams.WRAP_CONTENTï¼šå­è§†å›¾å¸Œæœ›æ ¹æ®å…¶å†…å®¹ç¡®å®šå®½åº¦ã€‚
   - **ä½œç”¨**ï¼šè¡¨ç¤ºå­è§†å›¾æœŸæœ›çš„å®½åº¦ï¼Œæ–¹æ³•ä¼šå°†å…¶ä¸çˆ¶è§†å›¾çš„çº¦æŸç»“åˆã€‚

### æ–¹æ³•å·¥ä½œåŸç†ï¼š

getChildMeasureSpec æ ¹æ®çˆ¶è§†å›¾çš„ widthMeasureSpecã€å·²ç”¨ç©ºé—´ï¼ˆpaddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼‰å’Œå­è§†å›¾çš„ lp.widthï¼Œè®¡ç®—å­è§†å›¾çš„ MeasureSpecã€‚ä»¥ä¸‹æ˜¯å…¶é€»è¾‘çš„é€æ­¥è§£æï¼ˆåŸºäº Android æºç ï¼Œç®€åŒ–æè¿°ï¼‰ï¼š

1. **æå–çˆ¶è§†å›¾çš„æ¨¡å¼å’Œå°ºå¯¸**ï¼š

   - ä» widthMeasureSpecä¸­æå–æ¨¡å¼å’Œå°ºå¯¸ï¼š

     ```int specMode = MeasureSpec.getMode(spec);```

     ```int specSize = MeasureSpec.getSize(spec);```

2. **è®¡ç®—å¯ç”¨å°ºå¯¸**ï¼š

   - å¯ç”¨å°ºå¯¸ä¸ºï¼š

     `int size = Math.max(0, specSize - padding);`

     - specSize æ˜¯çˆ¶è§†å›¾çš„å°ºå¯¸ï¼ˆæ¥è‡ª widthMeasureSpecï¼‰ã€‚
     - padding æ˜¯ç¬¬äºŒä¸ªå‚æ•°ï¼ˆpaddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼‰ã€‚
     - ç¡®ä¿å­è§†å›¾çš„å°ºå¯¸è€ƒè™‘äº†å†…è¾¹è·å’Œå¤–è¾¹è·çš„å ç”¨ã€‚

3. **ç¡®å®šå­è§†å›¾çš„ MeasureSpec**ï¼š æ ¹æ® lp.width å’Œçˆ¶è§†å›¾çš„ specModeï¼Œæ–¹æ³•å†³å®šå­è§†å›¾çš„ MeasureSpecï¼š

   - æƒ…å†µ 1ï¼šlp.width æ˜¯å…·ä½“å°ºå¯¸ï¼ˆå¦‚ 100 åƒç´ ï¼‰ï¼š
     - å­è§†å›¾å¸Œæœ›ä½¿ç”¨å›ºå®šå®½åº¦ã€‚
     - è¿”å›çš„ MeasureSpecï¼š
       - æ¨¡å¼ï¼šEXACTLY
       - å°ºå¯¸ï¼šlp.width
     - å­è§†å›¾å°†è¢«å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šçš„å®½åº¦ï¼Œå¿½ç•¥çˆ¶è§†å›¾çš„çº¦æŸï¼ˆé™¤éå°ºå¯¸ä¸ºè´Ÿï¼‰ã€‚
   - æƒ…å†µ 2ï¼šlp.width æ˜¯ MATCH_PARENTï¼š
     - å­è§†å›¾å¸Œæœ›å¡«æ»¡çˆ¶è§†å›¾çš„å¯ç”¨å®½åº¦ã€‚
     - æ ¹æ®çˆ¶è§†å›¾çš„ specModeï¼š
       - å¦‚æœ specModeæ˜¯ EXACTLYï¼š
         - å­è§†å›¾çš„ MeasureSpecï¼šEXACTLYï¼Œå°ºå¯¸ä¸º sizeï¼ˆå¯ç”¨å®½åº¦ï¼‰ã€‚
         - å­è§†å›¾å¿…é¡»ä¸çˆ¶è§†å›¾çš„å¯ç”¨å®½åº¦ä¸€è‡´ã€‚
       - å¦‚æœ specModeæ˜¯ AT_MOSTï¼š
         - å­è§†å›¾çš„ MeasureSpecï¼šAT_MOSTï¼Œå°ºå¯¸ä¸º sizeã€‚
         - å­è§†å›¾æœ€å¤§ä¸èƒ½è¶…è¿‡å¯ç”¨å®½åº¦ï¼Œä½†å¯ä»¥æ›´å°ã€‚
       - å¦‚æœ specModeæ˜¯ UNSPECIFIEDï¼š
         - å­è§†å›¾çš„ MeasureSpecï¼šUNSPECIFIEDï¼Œå°ºå¯¸ä¸º 0ã€‚
         - å­è§†å›¾æ²¡æœ‰å®½åº¦çº¦æŸã€‚
   - æƒ…å†µ 3ï¼šlp.width æ˜¯ WRAP_CONTENTï¼š
     - å­è§†å›¾å¸Œæœ›æ ¹æ®å†…å®¹ç¡®å®šå®½åº¦ã€‚
     - æ ¹æ®çˆ¶è§†å›¾çš„ specModeï¼š
       - å¦‚æœ specMode æ˜¯ EXACTLYæˆ– AT_MOSTï¼š
         - å­è§†å›¾çš„ MeasureSpecï¼šAT_MOSTï¼Œå°ºå¯¸ä¸º sizeã€‚
         - å­è§†å›¾å¯æ ¹æ®å†…å®¹å†³å®šå®½åº¦ï¼Œä½†ä¸èƒ½è¶…è¿‡å¯ç”¨å®½åº¦ã€‚
       - å¦‚æœ specMode æ˜¯ UNSPECIFIEDï¼š
         - å­è§†å›¾çš„ MeasureSpecï¼šUNSPECIFIEDï¼Œå°ºå¯¸ä¸º 0ã€‚
         - å­è§†å›¾å¯è‡ªç”±æ ¹æ®å†…å®¹å†³å®šå®½åº¦ã€‚

### ç¤ºä¾‹åœºæ™¯ï¼š

ä»¥ä¸‹æ˜¯ä¸€äº›å…·ä½“ç¤ºä¾‹ï¼Œå‡è®¾è°ƒç”¨ä¸ºï¼š

```java
getChildMeasureSpec(widthMeasureSpec, paddingLeft + paddingRight + lp.leftMargin + lp.rightMargin, lp.width)
```

#### åœºæ™¯ 1ï¼šçˆ¶è§†å›¾å›ºå®šå®½åº¦ï¼Œå­è§†å›¾æŒ‡å®šå®½åº¦

- è¾“å…¥ï¼š
  - widthMeasureSpecï¼šEXACTLYï¼Œå°ºå¯¸ 500 åƒç´ ã€‚
  - paddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼š50 åƒç´ ã€‚
  - lp.widthï¼š100 åƒç´ ã€‚
- è®¡ç®—ï¼š
  - å¯ç”¨å°ºå¯¸ï¼š500 - 50 = 450 åƒç´ ã€‚
  - ç”±äº lp.width æ˜¯å…·ä½“å°ºå¯¸ï¼ˆ100ï¼‰ï¼Œå¿½ç•¥çˆ¶è§†å›¾çš„çº¦æŸã€‚
- **è¾“å‡º**ï¼šMeasureSpec.EXACTLYï¼Œå°ºå¯¸ 100ã€‚
- **è§£é‡Š**ï¼šå­è§†å›¾è¢«å¼ºåˆ¶ä¸º 100 åƒç´ å®½ï¼Œå¿½ç•¥çˆ¶è§†å›¾çš„ 450 åƒç´ å¯ç”¨ç©ºé—´ã€‚

#### åœºæ™¯ 2ï¼šçˆ¶è§†å›¾æœ€å¤§å®½åº¦ï¼Œå­è§†å›¾ MATCH_PARENT

- è¾“å…¥ï¼š
  - widthMeasureSpecï¼šAT_MOSTï¼Œå°ºå¯¸ 500 åƒç´ ã€‚
  - paddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼š50 åƒç´ ã€‚
  - lp.widthï¼šMATCH_PARENTã€‚
- è®¡ç®—ï¼š
  - å¯ç”¨å°ºå¯¸ï¼š500 - 50 = 450 åƒç´ ã€‚
  - ç”±äº lp.width æ˜¯ MATCH_PARENT ä¸”çˆ¶è§†å›¾æ¨¡å¼ä¸º AT_MOSTï¼Œå­è§†å›¾æœ€å¤§å®½åº¦ä¸º 450 åƒç´ ã€‚
- **è¾“å‡º**ï¼šMeasureSpec.AT_MOSTï¼Œå°ºå¯¸ 450ã€‚
- **è§£é‡Š**ï¼šå­è§†å›¾å¯å¡«å……è‡³ 450 åƒç´ ï¼Œä½†å¯ä»¥æ›´å°ã€‚

#### åœºæ™¯ 3ï¼šçˆ¶è§†å›¾æ— çº¦æŸï¼Œå­è§†å›¾ WRAP_CONTENT

- è¾“å…¥ï¼š
  - widthMeasureSpecï¼šUNSPECIFIEDï¼Œå°ºå¯¸ 0ã€‚
  - paddingLeft + paddingRight + lp.leftMargin + lp.rightMarginï¼š50 åƒç´ ã€‚
  - lp.widthï¼šWRAP_CONTENTã€‚
- è®¡ç®—ï¼š
  - å¯ç”¨å°ºå¯¸ï¼š0 - 50 = 0ï¼ˆå– Math.max(0, -50)ï¼‰ã€‚
  - ç”±äºçˆ¶è§†å›¾æ¨¡å¼ä¸º UNSPECIFIEDï¼Œå­è§†å›¾æ— çº¦æŸã€‚
- **è¾“å‡º**ï¼šMeasureSpec.UNSPECIFIEDï¼Œå°ºå¯¸ 0ã€‚
- **è§£é‡Š**ï¼šå­è§†å›¾å¯æ ¹æ®å†…å®¹è‡ªç”±å†³å®šå®½åº¦ã€‚

### æ€»ç»“

getChildMeasureSpec æ˜¯ Android å¸ƒå±€ç³»ç»Ÿä¸­ç”¨äºåè°ƒçˆ¶å­è§†å›¾æµ‹é‡çš„é‡è¦å·¥å…·ã€‚å®ƒé€šè¿‡å¹³è¡¡çˆ¶è§†å›¾çš„ MeasureSpecã€å­è§†å›¾çš„ LayoutParams å’Œé¢å¤–çš„ç©ºé—´å ç”¨ï¼ˆå¦‚å†…è¾¹è·å’Œå¤–è¾¹è·ï¼‰ï¼Œç”Ÿæˆå­è§†å›¾çš„æµ‹é‡è§„æ ¼ã€‚ä¸Šè¿°è°ƒç”¨å…·ä½“å¤„ç†äº†å®½åº¦æ–¹å‘çš„æµ‹é‡ï¼Œè€ƒè™‘äº†çˆ¶è§†å›¾çš„å®½åº¦çº¦æŸã€å­è§†å›¾çš„å®½åº¦éœ€æ±‚ä»¥åŠå†…è¾¹è·å’Œå¤–è¾¹è·çš„å½±å“ï¼Œç¡®ä¿å¸ƒå±€è¿‡ç¨‹å‡†ç¡®ä¸”é«˜æ•ˆã€‚

---

## åã€å‡ ç‚¹è¡¥å……

| è¦ç‚¹                       | è¯´æ˜                                                        |
| -------------------------- | ----------------------------------------------------------- |
| æµ‹é‡åªå‘ç”Ÿä¸€æ¬¡ï¼Ÿ           | å¦ï¼Œæœ‰äº›å¸ƒå±€ï¼ˆå¦‚ LinearLayoutï¼‰ä¼šæµ‹é‡å­ View ä¸¤æ¬¡ï¼ˆweightï¼‰ |
| wrap_content ä¼šå½±å“å—ï¼Ÿ    | ä¼šï¼Œchild.getChildMeasureSpec() ä¼šå°† mode è®¾ä¸º AT_MOST      |
| UNSPECIFIED æ¨¡å¼åœ¨å“ªå‡ºç°ï¼Ÿ | ScrollViewã€åµŒå¥—å¸ƒå±€ä¸­å¯èƒ½ç”¨åˆ°                              |



------

## åä¸€ã€å°ç»“

| æ ¸å¿ƒæ­¥éª¤                 | è¯´æ˜                                                  |
| ------------------------ | ----------------------------------------------------- |
| `View.measure()`         | å¤–éƒ¨å…¥å£ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦ layout                         |
| `onMeasure()`            | çœŸæ­£è®¡ç®—å®½é«˜çš„åœ°æ–¹                                    |
| `getChildMeasureSpec()`  | çˆ¶æ§ä»¶æ ¹æ®è‡ªèº« MeasureSpec æ¨ç®—å­ View çš„ MeasureSpec |
| `setMeasuredDimension()` | æœ€ç»ˆè®¾ç½®æµ‹é‡ç»“æœ                                      |



## åäºŒã€ä»£ç ç¤ºä¾‹

```kotlin
package com.example.myapplicationtest.view

import android.content.Context
import android.util.AttributeSet
import android.view.View
import android.view.ViewGroup

/**
 * è‡ªå®šä¹‰ FlowLayout å¸ƒå±€ï¼Œç”¨äºè‡ªåŠ¨æ¢è¡Œæ’åˆ—å­è§†å›¾
 *
 * @param context ä¸Šä¸‹æ–‡ï¼Œç”¨äºåˆå§‹åŒ–è§†å›¾
 * @param attrs å±æ€§é›†ï¼ŒåŒ…å«è§†å›¾çš„è‡ªå®šä¹‰å±æ€§
 */
class FlowLayout @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null
) : ViewGroup(context, attrs) {

    // å­˜å‚¨æ‰€æœ‰è¡Œçš„è§†å›¾é›†åˆï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€è¡Œä¸­çš„è§†å›¾åˆ—è¡¨
    private val allLines = mutableListOf<MutableList<View>>()

    // å­˜å‚¨æ¯è¡Œçš„é«˜åº¦ï¼ˆåƒç´ ï¼‰
    private val lineHeights = mutableListOf<Int>()

    /**
     * æµ‹é‡æµç¨‹ - ç¡®å®šè§†å›¾åŠå…¶å­è§†å›¾çš„å¤§å°
     *
     * @param widthMeasureSpec çˆ¶å®¹å™¨æä¾›çš„å®½åº¦çº¦æŸ
     * @param heightMeasureSpec çˆ¶å®¹å™¨æä¾›çš„é«˜åº¦çº¦æŸ
     *
     * æµ‹é‡è¿‡ç¨‹æ­¥éª¤:
     * 1. è§£ææµ‹é‡æ¨¡å¼å’Œå°ºå¯¸
     * 2. æµ‹é‡æ¯ä¸ªå­è§†å›¾
     * 3. å°†å­è§†å›¾åˆ†ç»„åˆ°è¡Œä¸­
     * 4. è®¡ç®—æ€»é«˜åº¦å’Œæœ€å¤§å®½åº¦
     * 5. è®¾ç½®æœ€ç»ˆæµ‹é‡å°ºå¯¸
     */
    override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
        allLines.clear()
        lineHeights.clear()

        val widthMode = MeasureSpec.getMode(widthMeasureSpec)
        val widthSize = MeasureSpec.getSize(widthMeasureSpec)

        val heightMode = MeasureSpec.getMode(heightMeasureSpec)
        val heightSize = MeasureSpec.getSize(heightMeasureSpec)

        val parentWidth = if (widthMode == MeasureSpec.UNSPECIFIED) Int.MAX_VALUE else widthSize


        var lineViews = mutableListOf<View>() // å½“å‰è¡Œçš„è§†å›¾åˆ—è¡¨
        var lineWidth = 0  // å½“å‰è¡Œå·²ä½¿ç”¨çš„å®½åº¦
        var lineHeight = 0 // å½“å‰è¡Œæœ€å¤§é«˜åº¦

        var totalHeight = 0  // å¸ƒå±€æ€»é«˜åº¦ï¼ˆæ‰€æœ‰è¡Œé«˜ä¹‹å’Œï¼‰
        var maxLineWidth = 0 // æœ€å¤§è¡Œå®½ï¼ˆç”¨äºWRAP_CONTENTæ¨¡å¼ï¼‰

        for (i in 0 until childCount) {
            val child = getChildAt(i)
            if (child.visibility == GONE) continue

            // è·å–å­è§†å›¾çš„å¸ƒå±€å‚æ•°ï¼ˆæ”¯æŒMarginï¼‰
            val lp = child.layoutParams as MarginLayoutParams


            // paddingLeftï¼šçˆ¶è§†å›¾çš„å·¦å†…è¾¹è·ã€‚
            // paddingRightï¼šçˆ¶è§†å›¾çš„å³å†…è¾¹è·ã€‚
            // lp.leftMarginï¼šå­è§†å›¾çš„å·¦å¤–è¾¹è·ï¼Œæ¥è‡ªå…¶ LayoutParamsï¼ˆå¦‚ MarginLayoutParamsï¼‰ã€‚
            // lp.rightMarginï¼šå­è§†å›¾çš„å³å¤–è¾¹è·ã€‚
            // lp.widthï¼šå­è§†å›¾çš„ LayoutParams ä¸­æŒ‡å®šçš„å®½åº¦

            // æµ‹é‡å­ View
            val childWidthSpec = getChildMeasureSpec(
                widthMeasureSpec,
                paddingLeft + paddingRight + lp.leftMargin + lp.rightMargin,
                lp.width
            )


            val childHeightSpec = getChildMeasureSpec(
                heightMeasureSpec,
                paddingTop + paddingBottom + lp.topMargin + lp.bottomMargin,
                lp.height
            )
            child.measure(childWidthSpec, childHeightSpec)

            val childWidth = child.measuredWidth + lp.leftMargin + lp.rightMargin
            val childHeight = child.measuredHeight + lp.topMargin + lp.bottomMargin

            // åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢è¡Œ
            if (lineWidth + childWidth > parentWidth) {
                // ä¿å­˜ä¸Šä¸€è¡Œ
                allLines.add(lineViews)
                lineHeights.add(lineHeight)
                totalHeight += lineHeight
                maxLineWidth = maxOf(maxLineWidth, lineWidth)

                // å¼€å¯æ–°çš„ä¸€è¡Œ
                lineViews = mutableListOf()
                lineWidth = 0
                lineHeight = 0
            }

            // æ·»åŠ å½“å‰ View
            lineViews.add(child)
            lineWidth += childWidth
            lineHeight = maxOf(lineHeight, childHeight)
        }

        // æœ€åä¸€è¡Œä¹Ÿéœ€è¦æ·»åŠ 
        allLines.add(lineViews)
        lineHeights.add(lineHeight)
        totalHeight += lineHeight
        maxLineWidth = maxOf(maxLineWidth, lineWidth)

        val finalWidth =
            if (widthMode == MeasureSpec.EXACTLY) widthSize else maxLineWidth + paddingLeft + paddingRight
        val finalHeight =
            if (heightMode == MeasureSpec.EXACTLY) heightSize else totalHeight + paddingTop + paddingBottom

        // è®¾ç½®æœ€ç»ˆæµ‹é‡å°ºå¯¸
        setMeasuredDimension(finalWidth, finalHeight)
    }

    override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) {
        var curTop = paddingTop

        for (i in allLines.indices) {
            val lineViews = allLines[i]
            val lineHeight = lineHeights[i]

            var curLeft = paddingLeft

            for (child in lineViews) {
                if (child.visibility == GONE) continue

                val lp = child.layoutParams as MarginLayoutParams

                val left = curLeft + lp.leftMargin
                val top = curTop + lp.topMargin
                val right = left + child.measuredWidth
                val bottom = top + child.measuredHeight

                child.layout(left, top, right, bottom)

                curLeft += child.measuredWidth + lp.leftMargin + lp.rightMargin
            }

            curTop += lineHeight
        }
    }

    /**
     * ç”Ÿæˆæ”¯æŒMarginçš„å¸ƒå±€å‚æ•°
     *
     * è¿™ä½¿å¾—åœ¨XMLä¸­å¯ä»¥ä½¿ç”¨layout_marginå±æ€§ï¼š
     * <com.example.FlowLayout>
     *     <View android:layout_margin="8dp"/>
     * </com.example.FlowLayout>
     */
    override fun generateLayoutParams(attrs: AttributeSet?): LayoutParams {
        return MarginLayoutParams(context, attrs)
    }

    // å½“ä½¿ç”¨addView(View, LayoutParams)æ—¶ç”Ÿæˆæ­£ç¡®çš„å‚æ•°ç±»å‹
    override fun generateDefaultLayoutParams() =
        MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT)

    // æ£€æŸ¥ä¼ å…¥çš„å¸ƒå±€å‚æ•°ç±»å‹æ˜¯å¦æœ‰æ•ˆ
    override fun checkLayoutParams(p: LayoutParams?) = p is MarginLayoutParams
}
```

