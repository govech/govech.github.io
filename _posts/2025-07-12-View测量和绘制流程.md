## âœ… ä¸€ã€æ•´ä½“ View æ¸²æŸ“æµç¨‹ï¼ˆä¸‰æ­¥ï¼‰

```
ViewRootImpl.performTraversals()
 â”œâ”€â”€ measure()
 â”œâ”€â”€ layout()
 â””â”€â”€ draw()
```

æˆ‘ä»¬èšç„¦ç¬¬ 1 æ­¥ï¼š

------

## âœ… äºŒã€ä» `ViewRootImpl.performTraversals()` å¼€å§‹

```java
private void performTraversals() {
    ...
    performMeasure();
    ...
}
```

### ğŸ” æºç ç‰‡æ®µï¼š`performMeasure()`

```java
private void performMeasure() {
    ...
    view.measure(childWidthMeasureSpec, childHeightMeasureSpec);
    ...
}
```

- `view` æ˜¯ä½ çš„æ ¹ Viewï¼ˆé€šå¸¸æ˜¯ `DecorView`ï¼‰
- `childWidthMeasureSpec` æ˜¯ç³»ç»Ÿæ ¹æ®çª—å£å¤§å°å’Œ `LayoutParams` æ¨ç®—å‡ºæ¥çš„ `MeasureSpec`

------

## âœ… ä¸‰ã€View.measure() çš„å†…éƒ¨é€»è¾‘

```java
public final void measure(int widthMeasureSpec, int heightMeasureSpec) {
    if ((mPrivateFlags & PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT ||
        needsLayout()) {
        // ğŸš© çœŸæ­£å¼€å§‹æµ‹é‡
        onMeasure(widthMeasureSpec, heightMeasureSpec);
        mPrivateFlags &= ~PFLAG_FORCE_LAYOUT;
    }
}
```

> âœ… æ ¸å¿ƒç‚¹ï¼š`onMeasure()` æ˜¯æµ‹é‡å…³é”®ã€‚View/ViewGroup éƒ½ä¼šå®ç°å®ƒã€‚

------

## âœ… å››ã€æ·±å…¥ `View.onMeasure()`ï¼ˆé»˜è®¤å®ç°ï¼‰

```java
protected void onMeasure(int widthMeasureSpec, int heightMeasureSpec) {
    setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),
                         getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));
}
```

### ğŸ” `getDefaultSize(...)` çš„æºç ï¼š

```java
public static int getDefaultSize(int size, int measureSpec) {
    int mode = MeasureSpec.getMode(measureSpec);
    int specSize = MeasureSpec.getSize(measureSpec);

    switch (mode) {
        case MeasureSpec.UNSPECIFIED:
            return size;
        case MeasureSpec.AT_MOST:
        case MeasureSpec.EXACTLY:
        default:
            return specSize;
    }
}
```

ğŸ” æ‰€ä»¥é»˜è®¤ `View` ä¼š **ç›´æ¥æ¥å— MeasureSpec ç»™çš„å€¼**ï¼Œä¸åšè‡ªé€‚åº”å¤„ç†ã€‚

> â— å¦‚æœä½ ä¸é‡å†™ `onMeasure()`ï¼Œä½ çš„ `wrap_content` æ˜¯æ— æ•ˆçš„ï¼

------

## âœ… äº”ã€MeasureSpec åŸç†æ·±å…¥

```java
public static class MeasureSpec {
    // ä½ 30 ä½æ˜¯ sizeï¼Œé«˜ 2 ä½æ˜¯ mode
    static final int MODE_SHIFT = 30;
    static final int MODE_MASK  = 0x3 << MODE_SHIFT;

    public static int makeMeasureSpec(int size, int mode) {
        return (size & ~MODE_MASK) | (mode << MODE_SHIFT);
    }

    public static int getMode(int measureSpec) {
        return (measureSpec & MODE_MASK) >> MODE_SHIFT;
    }

    public static int getSize(int measureSpec) {
        return (measureSpec & ~MODE_MASK);
    }
}
```

- `MeasureSpec` æ˜¯ä¸€ä¸ª 32 ä½ intï¼š
  - é«˜ä¸¤ä½è¡¨ç¤º Mode
  - ä½ 30 ä½è¡¨ç¤º Size

------

## âœ… å…­ã€ViewGroup çš„ onMeasureï¼šæµ‹é‡å­ View

ä»¥ `LinearLayout` ä¸ºä¾‹ï¼Œçœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæµ‹é‡æ¯ä¸ªå­ View çš„ï¼š

### ğŸ“Œ é‡ç‚¹æºç ï¼š`LinearLayout.onMeasure()`

```java
for (int i = 0; i < count; ++i) {
    View child = getChildAt(i);
    if (child.getVisibility() != GONE) {
        measureChildWithMargins(child, widthMeasureSpec, 0, heightMeasureSpec, 0);

        // è®°å½•æœ€å¤§å®½é«˜ã€å¤„ç† weightã€wrap_content ç­‰é€»è¾‘
    }
}
```

### ğŸ” æ ¸å¿ƒæ–¹æ³•ï¼š`measureChildWithMargins(...)`

```java
protected void measureChildWithMargins(
    View child, int parentWidthMeasureSpec, int widthUsed,
    int parentHeightMeasureSpec, int heightUsed
) {
    final MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();

    final int childWidthMeasureSpec = getChildMeasureSpec(
        parentWidthMeasureSpec,
        mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin + widthUsed,
        lp.width
    );

    final int childHeightMeasureSpec = getChildMeasureSpec(
        parentHeightMeasureSpec,
        mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin + heightUsed,
        lp.height
    );

    child.measure(childWidthMeasureSpec, childHeightMeasureSpec);
}
```

### ğŸ” åˆè·³åˆ°äº†ï¼š`ViewGroup.getChildMeasureSpec()`

```java
public static int getChildMeasureSpec(int spec, int padding, int childDimension) {
    int specMode = MeasureSpec.getMode(spec);
    int specSize = MeasureSpec.getSize(spec);
    int size = Math.max(0, specSize - padding);

    if (childDimension >= 0) {
        return MeasureSpec.makeMeasureSpec(childDimension, MeasureSpec.EXACTLY);
    } else if (childDimension == LayoutParams.MATCH_PARENT) {
        return MeasureSpec.makeMeasureSpec(size, specMode);
    } else if (childDimension == LayoutParams.WRAP_CONTENT) {
        if (specMode == MeasureSpec.EXACTLY || specMode == MeasureSpec.AT_MOST) {
            return MeasureSpec.makeMeasureSpec(size, MeasureSpec.AT_MOST);
        } else {
            return MeasureSpec.makeMeasureSpec(0, MeasureSpec.UNSPECIFIED);
        }
    }
}
```

> âœ… è¿™ä¸ªæ–¹æ³•æ˜¯å…³é”®ï¼š**çˆ¶æ§ä»¶æ ¹æ®è‡ªå·±çš„ MeasureSpec + padding + å­æ§ä»¶ LayoutParamsï¼Œæ„é€ å­æ§ä»¶çš„ MeasureSpec**

------

## âœ… ä¸ƒã€æœ€ç»ˆæµ‹é‡å®Œæˆ

æ‰€æœ‰ `View`ã€`ViewGroup` åœ¨ `onMeasure()` å†…é€šè¿‡å­ View çš„æµ‹é‡å’Œå°ºå¯¸ç¡®å®šè‡ªå·±çš„å®½é«˜ï¼Œå¹¶è°ƒç”¨ï¼š

```java
setMeasuredDimension(measuredWidth, measuredHeight)
```

è‡³æ­¤ï¼Œæµ‹é‡æµç¨‹ç»“æŸï¼Œè¿›å…¥ layout é˜¶æ®µã€‚

------

## âœ… å…«ã€æµç¨‹å›¾æ€»ç»“ï¼ˆè¶…æ¸…æ™°ï¼ï¼‰

```
ViewRootImpl.performTraversals()
 â””â”€â”€ performMeasure()
     â””â”€â”€ rootView.measure()
         â””â”€â”€ onMeasure()
             â”œâ”€â”€ View: è®¡ç®—è‡ªå·±éœ€è¦çš„å¤§å°
             â””â”€â”€ ViewGroup:
                 â”œâ”€â”€ éå†å­ View
                 â”œâ”€â”€ getChildMeasureSpec()
                 â””â”€â”€ child.measure()
                        â””â”€â”€ child.onMeasure()
```

------

## âœ… ä¹ã€å‡ ç‚¹è¡¥å……

| è¦ç‚¹                       | è¯´æ˜                                                        |
| -------------------------- | ----------------------------------------------------------- |
| æµ‹é‡åªå‘ç”Ÿä¸€æ¬¡ï¼Ÿ           | å¦ï¼Œæœ‰äº›å¸ƒå±€ï¼ˆå¦‚ LinearLayoutï¼‰ä¼šæµ‹é‡å­ View ä¸¤æ¬¡ï¼ˆweightï¼‰ |
| wrap_content ä¼šå½±å“å—ï¼Ÿ    | ä¼šï¼Œchild.getChildMeasureSpec() ä¼šå°† mode è®¾ä¸º AT_MOST      |
| UNSPECIFIED æ¨¡å¼åœ¨å“ªå‡ºç°ï¼Ÿ | ScrollViewã€åµŒå¥—å¸ƒå±€ä¸­å¯èƒ½ç”¨åˆ°                              |



------

## âœ… åã€å°ç»“

| æ ¸å¿ƒæ­¥éª¤                 | è¯´æ˜                                                  |
| ------------------------ | ----------------------------------------------------- |
| `View.measure()`         | å¤–éƒ¨å…¥å£ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦ layout                         |
| `onMeasure()`            | çœŸæ­£è®¡ç®—å®½é«˜çš„åœ°æ–¹                                    |
| `getChildMeasureSpec()`  | çˆ¶æ§ä»¶æ ¹æ®è‡ªèº« MeasureSpec æ¨ç®—å­ View çš„ MeasureSpec |
| `setMeasuredDimension()` | æœ€ç»ˆè®¾ç½®æµ‹é‡ç»“æœ                                      |



## âœ… åä¸€ã€ä»£ç ç¤ºä¾‹

```kotlin
package com.example.myapplicationtest.view

import android.content.Context
import android.util.AttributeSet
import android.view.View
import android.view.ViewGroup

/**
 * è‡ªå®šä¹‰ FlowLayout å¸ƒå±€ï¼Œç”¨äºè‡ªåŠ¨æ¢è¡Œæ’åˆ—å­è§†å›¾
 *
 * @param context ä¸Šä¸‹æ–‡ï¼Œç”¨äºåˆå§‹åŒ–è§†å›¾
 * @param attrs å±æ€§é›†ï¼ŒåŒ…å«è§†å›¾çš„è‡ªå®šä¹‰å±æ€§
 */
class FlowLayout @JvmOverloads constructor(
    context: Context,
    attrs: AttributeSet? = null
) : ViewGroup(context, attrs) {

    // å­˜å‚¨æ‰€æœ‰è¡Œçš„è§†å›¾é›†åˆï¼Œæ¯ä¸ªå…ƒç´ ä»£è¡¨ä¸€è¡Œä¸­çš„è§†å›¾åˆ—è¡¨
    private val allLines = mutableListOf<MutableList<View>>()

    // å­˜å‚¨æ¯è¡Œçš„é«˜åº¦ï¼ˆåƒç´ ï¼‰
    private val lineHeights = mutableListOf<Int>()

    /**
     * æµ‹é‡æµç¨‹ - ç¡®å®šè§†å›¾åŠå…¶å­è§†å›¾çš„å¤§å°
     *
     * @param widthMeasureSpec çˆ¶å®¹å™¨æä¾›çš„å®½åº¦çº¦æŸ
     * @param heightMeasureSpec çˆ¶å®¹å™¨æä¾›çš„é«˜åº¦çº¦æŸ
     *
     * æµ‹é‡è¿‡ç¨‹æ­¥éª¤:
     * 1. è§£ææµ‹é‡æ¨¡å¼å’Œå°ºå¯¸
     * 2. æµ‹é‡æ¯ä¸ªå­è§†å›¾
     * 3. å°†å­è§†å›¾åˆ†ç»„åˆ°è¡Œä¸­
     * 4. è®¡ç®—æ€»é«˜åº¦å’Œæœ€å¤§å®½åº¦
     * 5. è®¾ç½®æœ€ç»ˆæµ‹é‡å°ºå¯¸
     */
    override fun onMeasure(widthMeasureSpec: Int, heightMeasureSpec: Int) {
        allLines.clear()
        lineHeights.clear()

        val widthMode = MeasureSpec.getMode(widthMeasureSpec)
        val widthSize = MeasureSpec.getSize(widthMeasureSpec)

        val heightMode = MeasureSpec.getMode(heightMeasureSpec)
        val heightSize = MeasureSpec.getSize(heightMeasureSpec)

        val parentWidth = if (widthMode == MeasureSpec.UNSPECIFIED) Int.MAX_VALUE else widthSize


        var lineViews = mutableListOf<View>() // å½“å‰è¡Œçš„è§†å›¾åˆ—è¡¨
        var lineWidth = 0  // å½“å‰è¡Œå·²ä½¿ç”¨çš„å®½åº¦
        var lineHeight = 0 // å½“å‰è¡Œæœ€å¤§é«˜åº¦

        var totalHeight = 0  // å¸ƒå±€æ€»é«˜åº¦ï¼ˆæ‰€æœ‰è¡Œé«˜ä¹‹å’Œï¼‰
        var maxLineWidth = 0 // æœ€å¤§è¡Œå®½ï¼ˆç”¨äºWRAP_CONTENTæ¨¡å¼ï¼‰

        for (i in 0 until childCount) {
            val child = getChildAt(i)
            if (child.visibility == GONE) continue

            // è·å–å­è§†å›¾çš„å¸ƒå±€å‚æ•°ï¼ˆæ”¯æŒMarginï¼‰
            val lp = child.layoutParams as MarginLayoutParams


            // paddingLeftï¼šçˆ¶è§†å›¾çš„å·¦å†…è¾¹è·ã€‚
            // paddingRightï¼šçˆ¶è§†å›¾çš„å³å†…è¾¹è·ã€‚
            // lp.leftMarginï¼šå­è§†å›¾çš„å·¦å¤–è¾¹è·ï¼Œæ¥è‡ªå…¶ LayoutParamsï¼ˆå¦‚ MarginLayoutParamsï¼‰ã€‚
            // lp.rightMarginï¼šå­è§†å›¾çš„å³å¤–è¾¹è·ã€‚
            // lp.widthï¼šå­è§†å›¾çš„ LayoutParams ä¸­æŒ‡å®šçš„å®½åº¦

            // æµ‹é‡å­ View
            val childWidthSpec = getChildMeasureSpec(
                widthMeasureSpec,
                paddingLeft + paddingRight + lp.leftMargin + lp.rightMargin,
                lp.width
            )


            val childHeightSpec = getChildMeasureSpec(
                heightMeasureSpec,
                paddingTop + paddingBottom + lp.topMargin + lp.bottomMargin,
                lp.height
            )
            child.measure(childWidthSpec, childHeightSpec)

            val childWidth = child.measuredWidth + lp.leftMargin + lp.rightMargin
            val childHeight = child.measuredHeight + lp.topMargin + lp.bottomMargin

            // åˆ¤æ–­æ˜¯å¦éœ€è¦æ¢è¡Œ
            if (lineWidth + childWidth > parentWidth) {
                // ä¿å­˜ä¸Šä¸€è¡Œ
                allLines.add(lineViews)
                lineHeights.add(lineHeight)
                totalHeight += lineHeight
                maxLineWidth = maxOf(maxLineWidth, lineWidth)

                // å¼€å¯æ–°çš„ä¸€è¡Œ
                lineViews = mutableListOf()
                lineWidth = 0
                lineHeight = 0
            }

            // æ·»åŠ å½“å‰ View
            lineViews.add(child)
            lineWidth += childWidth
            lineHeight = maxOf(lineHeight, childHeight)
        }

        // æœ€åä¸€è¡Œä¹Ÿéœ€è¦æ·»åŠ 
        allLines.add(lineViews)
        lineHeights.add(lineHeight)
        totalHeight += lineHeight
        maxLineWidth = maxOf(maxLineWidth, lineWidth)

        val finalWidth =
            if (widthMode == MeasureSpec.EXACTLY) widthSize else maxLineWidth + paddingLeft + paddingRight
        val finalHeight =
            if (heightMode == MeasureSpec.EXACTLY) heightSize else totalHeight + paddingTop + paddingBottom

        // è®¾ç½®æœ€ç»ˆæµ‹é‡å°ºå¯¸
        setMeasuredDimension(finalWidth, finalHeight)
    }

    override fun onLayout(changed: Boolean, l: Int, t: Int, r: Int, b: Int) {
        var curTop = paddingTop

        for (i in allLines.indices) {
            val lineViews = allLines[i]
            val lineHeight = lineHeights[i]

            var curLeft = paddingLeft

            for (child in lineViews) {
                if (child.visibility == GONE) continue

                val lp = child.layoutParams as MarginLayoutParams

                val left = curLeft + lp.leftMargin
                val top = curTop + lp.topMargin
                val right = left + child.measuredWidth
                val bottom = top + child.measuredHeight

                child.layout(left, top, right, bottom)

                curLeft += child.measuredWidth + lp.leftMargin + lp.rightMargin
            }

            curTop += lineHeight
        }
    }

    /**
     * ç”Ÿæˆæ”¯æŒMarginçš„å¸ƒå±€å‚æ•°
     *
     * è¿™ä½¿å¾—åœ¨XMLä¸­å¯ä»¥ä½¿ç”¨layout_marginå±æ€§ï¼š
     * <com.example.FlowLayout>
     *     <View android:layout_margin="8dp"/>
     * </com.example.FlowLayout>
     */
    override fun generateLayoutParams(attrs: AttributeSet?): LayoutParams {
        return MarginLayoutParams(context, attrs)
    }

    // å½“ä½¿ç”¨addView(View, LayoutParams)æ—¶ç”Ÿæˆæ­£ç¡®çš„å‚æ•°ç±»å‹
    override fun generateDefaultLayoutParams() =
        MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT)

    // æ£€æŸ¥ä¼ å…¥çš„å¸ƒå±€å‚æ•°ç±»å‹æ˜¯å¦æœ‰æ•ˆ
    override fun checkLayoutParams(p: LayoutParams?) = p is MarginLayoutParams
}
```

